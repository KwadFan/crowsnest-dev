#!/bin/bash

#### Crowsnest Core Application.

#### crowsnest - A webcam Service for multiple Cams and Stream Services.
####
#### Written by Stephan Wendel aka KwadFan <me@stephanwe.de>
#### Copyright 2021 - till today
#### https://github.com/mainsail-crew/crowsnest
####
#### This File is distributed under GPLv3
####

# shellcheck enable=require-variable-braces

# Exit upon Errors
set -Ee


CN_WORKDIR_PATH="$(dirname "$(readlink -f "${0}")")"
declare -r CN_WORKDIR_PATH

cn_import_components() {
    local -a components
    local files
    files="$(find "${CN_WORKDIR_PATH}/components/" -type f -not -name '.*' -printf '%f\n')"

    for file in ${files}; do
        components+=("${file}")
    done

    for component in "${components[@]}"; do
        # shellcheck disable=SC1090
        . "${CN_WORKDIR_PATH}"/components/"${component}"
    done
}

cn_err_exit() {
    local file_trace func_trace line_trace
    read -r LINE FUNC FILE < <(caller 0)
    func_trace="${FUNC}"
    file_trace="$(basename "${FILE}")"
    line_trace="${LINE}"
    if [ "${1}" != "0" ]; then
        log_msg "ERROR: Error ${1} occured on line ${line_trace}"
        log_msg "==> Error occured in file: ${file_trace} -> ${func_trace}"
        log_msg "ERROR: Stopping $(basename "$0")."
        log_msg "Goodbye..."
    fi
    if [ -n "$(jobs -pr)" ]; then
        jobs -pr | while IFS='' read -r job_id; do
            kill "${job_id}"
        done
    fi
    exit 1
}

cn_shutdown() {
    log_msg "Shutdown or Killed by User!"
    log_msg "Please come again :)"
    if [ -n "$(jobs -pr)" ]; then
        jobs -pr | while IFS='' read -r job_id; do
            kill "${job_id}"
        done
    fi
    log_msg "Goodbye..."
    exit 0
}

main() {

    cn_import_components

    if [ "$#" -eq 0 ]; then
        missing_args_msg
        exit 1
    fi

    while getopts ":vhc:d" arg; do
    case "${arg}" in
        v )
            echo -e "\ncrowsnest Version: $(self_version)\n"
            exit 0
        ;;
        h )
            help_msg
            exit 0
        ;;
        c )
            check_cfg "${OPTARG}"
            export CROWSNEST_CFG="${OPTARG}"
        ;;
        d )
            set -x
        ;;
        \?)
            wrong_args_msg
            exit 1
        ;;
    esac
done


    trap 'cn_shutdown' 1 2 3 15
    trap 'cn_err_exit $? $LINENO' ERR



    # test err_exit

    exec foo

    echo "${@}"
}

if [[ "${BASH_SOURCE[0]}" = "${0}" ]]; then
    main "${@}"
fi
